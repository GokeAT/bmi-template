piepline {
    agent any
    environment {
            DATABASE_URI= credentials("DATABASE_URI")
            SECRET_KEY = credentials("SECRET_KEY")
            DOCKER_LOGIN = credentials("DOCKER_LOGIN")
    }
    stages {
        stage('Test'){
            steps{
                sh 'bash jenkins/test.sh'
            }  
        }
    stages('Setup Docker'){
        steps {
            sh 'bash jenkins/setup-docker.sh'
        }
    }
    }
    stages {
        stage('Build'){
            steps {
                sh 'docker build -t gokeat/bmi-template:latest .' 
            }  
        }
    }
    stages {
        stage('Push'){
            steps{
                sh 'docker push gokeat/bmi-template:latest' 
            } 
        }
    }
    stages {
        stage('Run'){
            steps{
                sh 'docker run -d -p 80:5000 -e DATABASE_URI=$DATABASE_URI -e SECRET_KEY=$SECRET_KEY --name -bmi-template gokeat/bmi-template ' 
            }  
        }
    }
    post {
        always{
            junit '**/*.xml'
            cobertura coberturaReportFile: 'coverage.xml', failNoReports: false
        }

    }
}